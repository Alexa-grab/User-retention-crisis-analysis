#### Учебный проект

от Karpov.Courses [Karpov.Courses](https://karpov.courses/simulator)

# Анализ ключевых событий приложения: маркетинговая компания и сбой аудитории

 **Дашборд для анализа ключевых событий приложения:**
  
 - Отслеживание пользовательской активности и retention;
 - Мониторинг метрик вовлеченности (лайки, просмотры, CTR);
 - Демографический анализ аудитории (гео, возраст, устройства);
 - Выявление аномалий и точек роста.
   
## Вводные данные

**1. Социальная сеть с двумя сервисами:**

   - Лента новостей - просмотр и лайки постов
   - Мессенджер - обмен сообщениями

**2. Все события хранятся в ClickHouse:**

   - feed_actions - действия в ленте (просмотры, лайки)
   - message_actions - отправка сообщений

**3. Произошедшие события:**

   - **15.08.25**: была проведена маркетинговая компания для привлечения новых пользовталей.
   
   - **24.08.25**: произошло резкое падение аудитории.

## Задачи
 **1. Анализ маркетинговой компании:**
 
   - Проанализировать характер Retention пользователей, привлечённых рекламной кампанией.
   - Что стало с рекламными пользователями в дальнейшем, как часто они продолжают пользоваться приложением.
     
 **2. Анализ внезапного падения аудитрии**
 
   - Выяснить, какие пользователи не смогли воспользоваться лентой. Что их объединяет.

## Инструменты

- **База данных:** ClickHouse
- **BI-инструменты:** Superset, Redash

**Структура таблицы БД**

**1. Feed_actions**

   - **post_id:** id поста;
   - **user_id:** id пользователя;
   - **action:** совершенное действие view/like;
   - **time:** время совершенного действия;
   - **gender:** пол пользователя;
   - **city:** город пользователя;
   - **country:** страна пользователя;
   - **os:** тип операционной системы;
   - **source:** источник входа(органический/рекламный).

## Анализ аудитории: Общие данные
![Анализ аудитории:общие данные](https://github.com/Alexa-grab/desktop-tutorial/blob/main/%D0%BE%D0%B1%D1%89%D0%B81.png)

- ### DAU
  
  **Выводы по графику**
  
   - 15.08.25 резко увеличилось количество аудитории,что совпадает с днем проведения маркетинговой акции.
   - 24.08.25 резкая просадка аудитории,возможно произошел технический сбой и часть пользователей не смогла воспользоваться приложением.

- ### Общая динамика удержания пользователей (Retention) по неделям

  **Выводы по графику**  
    - График удержания демонстрирует позитивную динамику: в течение первых двух месяцев наблюдается уверенный рост лояльности пользователей, после чего метрика стабилизировалась, выйдя на устойчивое плато.Это указывает на то, что продукт или маркетинговая кампания успешно сформировали стабильное ядро лояльной аудитории.
    
   **SQL запросы к графику**    
  ```
  -- Анализ еженедельного Retention: новых, вернувшихся и ушедших пользователей

  -- Анализ ушедших пользователей (статус= 'gone')

  SELECT
   this_week,
   previous_week,
   -uniq(user_id) as count_users,-- Отрицательное значение для визуализации оттока
   status 
  FROM
  (
   SELECT
    user_id ,
    groupUniqArray(toMonday(toDate(time))) as weeks_visited, -- Массив всех недель посещения для каждого пользователя
    arrayJoin(weeks_visited) as previous_week, -- Разворачиваем массив в строки (каждая неделя как отдельная запись)
    addWeeks(previous_week,+1) as this_week, -- Следующая неделя после посещения
   'gone' as status -- Статус "ушел"
   FROM simulator_20250720.feed_actions 
   GROUP BY user_id
  )
  where NOT has(weeks_visited, this_week)  -- Фильтр: пользователь НЕ был активен на следующей неделе
  AND this_week <= toMonday(today())     -- Только завершенные недели (исключаем текущую)
  GROUP BY this_week,previous_week,status

  UNION ALL -- Объединяем с результатом анализа новых и вернувшихся пользователей

  -- Анализ новых и продолжающих пользователей (статус='retained' и 'new')

  SELECT
  this_week,
  previous_week,
  toInt64(uniq(user_id)) as count_users, -- Положительное значение для прироста
  status
  FROM
   (
    SELECT
     user_id ,
     groupUniqArray(toMonday(toDate(time))) as weeks_visited,
     arrayJoin(weeks_visited) AS this_week,   -- Текущая неделя активности
     addWeeks(this_week,-1) as previous_week, -- Предыдущая неделя
    IF                                        -- Проверяем был ли пользователь активен на предыдущей неделе
     (
     has(weeks_visited,addWeeks(this_week,-1)),
     'retained',                               -- Если ДА  - "вернувшийся"
     'new'                                     -- Если НЕТ - "новый"
      ) as status
     FROM simulator_20250720.feed_actions 
     GROUP BY user_id
   )
  GROUP BY this_week,previous_week,status
  ```
## Событие № 1: Анализ проведенной маркетинговой компании 

![Аудиторные данные](https://github.com/Alexa-grab/desktop-tutorial/blob/main/%D1%80%D0%B5%D0%BA%D0%BB%D0%B0%D0%BC%D0%BD%D0%B0%D1%8F%20%D0%BA%D0%BE%D0%BC%D0%BF%D0%B0%D0%BD%D0%B8%D1%8F%201.png)

- ### DAU за период с 12.08.25 по 19.08.25

  **Выводы по графику**
    - Маркетинговая кампания вызвала высокий всплеск активности (DAU), достигнув пика 15 августа.

- ### Пользователи привлеченные рекламной компанией

  **Выводы по графику**
  
    - Маркетинговая кампания дала значительный прирост: в день пика зафиксировано **8370** пользователей с рекламного трафика,что на **38%** больше, чем неделей ранее. Из них **2592** были новыми пользователями.

- ### Ретеншен 1-го дня и последущая активность новых пользователей

![heatmap](https://github.com/Alexa-grab/desktop-tutorial/blob/main/%D1%80%D0%B5%D0%BA%D0%BB%D0%B0%D0%BC%D0%BD%D0%B0%D1%8F%20%D0%BA%D0%BE%D0%BC%D0%BF%D0%B0%D0%BD%D0%B8%D1%8F%203.png)
![Ретеншен 1го дня](https://github.com/Alexa-grab/desktop-tutorial/blob/main/%D1%80%D0%B5%D0%BA%D0%BB%D0%B0%D0%BC%D0%BD%D0%B0%D1%8F%20%D0%BA%D0%BE%D0%BC%D0%BF%D0%B0%D0%BD%D0%B8%D1%8F%207.png)

  **Выводы по графикам**
  
   - Динамика удержания когорты от **15.08.25** тревожная: начавшись с крайне низкого показателя в **3.97%**, Retention продолжил снижаться и стабилизировался на отметке всего **1.31%**.

  **SQL запросы к графикам:**

   - **Heatmap retantion (тепловая карта)**
  ```
  -- Heatmap retention для анализа удержания пользователей
  SELECT
    toString(date) as date,           -- Дата активности (конвертируем в строку для визуализации)
    toString(start_date) as start_date, -- Дата первого визита когорты (также в строку)
    COUNT(user_id) as active_users,   -- Количество активных пользователей из когорты
    source                            -- Источник трафика ('ads' или 'organic')
  FROM
    -- Подзапрос t1: определяем когорты пользователей из рекламного трафика
     (
  SELECT
        user_id,
        MIN(toDate(time)) as start_date,  -- Находим дату первого визита каждого пользователя
        source 
     FROM simulator_20250820.feed_actions
     WHERE source = 'ads'                 -- Фильтруем только рекламный трафик
     GROUP BY  user_id, source
     HAVING start_date between '2025-08-12' and '2025-08-19'  -- Берем когорты за 8-дневный период
     ) t1
    
    JOIN
    -- Подзапрос t2: все даты активности всех пользователей
    (
      SELECT
        distinct user_id,
        toDate(time) as date 
      FROM simulator_20250820.feed_actions 
    ) t2
  USING (user_id)  -- Соединяем по user_id чтобы найти все активности каждой когорты

  GROUP BY date, start_date, source  -- Группируем для подсчета пользователей по дате, когорте и источнику

  UNION ALL  -- Объединяем результаты (без удаления дубликатов)

  -- Аналогичный запрос для органического трафика
  SELECT
    toString(date) as date,
    toString(start_date) as start_date,
    count(user_id) as active_users,
    source
  FROM
    -- Подзапрос для органического трафика
    (SELECT
        user_id,
        MIN(toDate(time)) as start_date,
        source 
     FROM simulator_20250820.feed_actions
     WHERE source = 'organic'            -- Фильтруем только органический трафик
     GROUP BY user_id, source
     HAVING start_date between '2025-08-12' and '2025-08-19'  -- Тот же период когорт
    ) t1
    
  JOIN
    -- Тот же подзапрос с активностями 
    (
      SELECT
        distinct user_id,
        toDate(time) as date 
      FROM simulator_20250820.feed_actions 
    ) t2
    USING (user_id)

  GROUP BY date, start_date, source

  ```

 - **Retantion 1-го дня и дальнейшее поведение когорты**
   
  ```
  SELECT 
    date,                        -- дата активности
    COUNT(user_id) as num_users, -- Количество уникальных пользователей за дату и источник
    source,                      -- Источник трафика
    (num_users / first_day_users) as percentage_of_first_day  -- Retention rate: % от первоначальной когорты
 FROM 
   (
    SELECT 
        t2.date,
        t2.source,
        t1.start_day,
        t1.user_id,

        -- Оконная функция: для каждого источника считаем сколько пользователей было в их первый день
        -- CountIf считает только те строки, где дата активности совпадает с первым днем пользователя

        CountIf(t1.user_id, t2.date = t1.start_day) OVER (PARTITION BY t2.source) as first_day_users
     FROM 
       (
        -- Подзапрос t1: находим когорту пользователей, которые впервые появились 2025-08-15
        SELECT 
            user_id,
            MIN(toDate(time)) as start_day      -- Первый день активности каждого пользователя
        FROM simulator_20250820.feed_actions 
        GROUP BY user_id 
        HAVING MIN(toDate(time)) = '2025-08-15' -- Фильтруем только пользователей дня '2025-08-15'
       ) t1

      JOIN

      (
        -- Подзапрос t2: все активности пользователей с их датами и источниками
        SELECT DISTINCT 
            user_id, 
            toDate(time) as date,
            source 
        FROM simulator_20250820.feed_actions 
      ) t2
     USING (user_id)  -- Соединяем по user_id чтобы получить все активности когорты
    )
  -- Группируем по дате, источнику и first_day_users (который постоянен для каждого источника)
  GROUP BY date, source, first_day_users
  ORDER BY date, source
  ```
- ### Лайки и просмотры / CTR
![Активность привлеченной аудитории](https://github.com/Alexa-grab/desktop-tutorial/blob/main/%D1%80%D0%B5%D0%BA%D0%BB%D0%B0%D0%BC%D0%BD%D0%B0%D1%8F%20%D0%BA%D0%BE%D0%BC%D0%BF%D0%B0%D0%BD%D0%B8%D1%8F%206.png)

   **Выводы по графикам**
   
   - Низкий уровень вовлеченности;
   - CTR показывает недостаточную заинтересованность контентом;
   - Показатели лайков и просмотров свидетельствуют о поверхностном взаимодействии с платформой;
   - Между количеством просмотров и активными действиями (лайки) существует значительный разрыв,значит пользователи потребляют контент пассивно, без активного участия.
     
 - ### Демография аудитории

![Аудитория](https://github.com/Alexa-grab/desktop-tutorial/blob/main/%D1%80%D0%B5%D0%BA%D0%BB%D0%B0%D0%BC%D0%BD%D0%B0%D1%8F%20%D0%BA%D0%BE%D0%BC%D0%BF%D0%B0%D0%BD%D0%B8%D1%8F%205.png)

   **Выводы по графикам**

   - Целевая аудитория - молодые женщины 18-24 лет из крупных городов;
   - Высокая урбанизация - более 83% аудитории сосредоточено в двух столицах (Москва и Санкт-Петербург);
   - Мобильный трафик - преобладание Android указывает на важность мобильной оптимизации.

  **SQL запросы к графикам**
   
  - **Пол/возраст/ОС**   
   ```
    SELECT 
      toDate(time) AS day,
      user_id,
      CASE
         WHEN gender = 1 THEN 'Woman'
         WHEN gender = 0 THEN 'Man'
         ELSE 'Unknown'
      END AS gender_text,
      CASE 
        WHEN age <= 17 THEN 'До 17' 
        WHEN age > 17 AND age <= 24 THEN '18-24 лет' 
        WHEN age > 24 AND age <= 34 THEN '25-34 лет' 
        WHEN age > 34 AND age <= 44 THEN '35-44 лет' 
        WHEN age > 44 AND age <= 54 THEN '45-54 лет' 
        WHEN age > 54 THEN '55+' 
        ELSE 'Не указан'
     END AS age_group,
     action,
     source,
     city,
     os
   FROM simulator_20250820.feed_actions 
   WHERE  user_id IN
    (
    SELECT user_id
    FROM simulator_20250820.feed_actions 
    GROUP by user_id 
    HAVING MIN(toDate(time))='2025-08-15'
    )
   ```

  - **Топ - 5 самых популярных городов** 
 
  ```
    SELECT 
     city,
     COUNT(distinct user_id) as num_users_city,
     source
    FROM simulator_20250820.feed_actions 
    WHERE toDate(time) = '2025-08-15' and source='ads'
    AND user_id IN
     (
      SELECT
       user_id 
      FROM simulator_20250820.feed_actions 
      GROUP BY user_id 
      HAVING min(toDate(time)) = '2025-08-15'
      )
    GROUP BY city,source
    ORDER BY num_users_city DESC
    LIMIT 5

    UNION All

    SELECT 
     city,
     COUNT(distinct user_id) as num_users_city,
     source
    FROM simulator_20250820.feed_actions 
    WHERE toDate(time) = '2025-08-15' and source='organic'
    AND user_id IN
     (
      SELECT
       user_id 
      FROM simulator_20250820.feed_actions 
      GROUP BY user_id 
      HAVING min(toDate(time)) = '2025-08-15'
      )
    GROUP BY city,source
    ORDER BY num_users_city DESC
    LIMIT 5
  ```
## Маркетинговая компания: Основные выводы и рекомендации

 **1. Основные выводы:**
  
  - Привлечено 2 592 пользователя (3.3% от общей базы);
  - Ядро аудитории: женщины 18-24 лет из Москвы/СПб (Android);
  - Катастрофически низкий retention: с 3.97% до 1% за 4 недели;
  - Активность падает после первого дня, интерес не удерживается.

**2. Критические проблемы:**
  
  - Реклама привлекает, но продукт не удерживает;
  - Аудитория уходит после первого знакомства;
  - Нет постоянной вовлеченности.

 **3. Срочные рекомендации:**

  - Пересмотреть онбординг - улучшить первое впечатление;
  - Проанализировать соответствие рекламных обещаний и реального функционала;
  - Оптимизировать контент под целевую аудиторию (женщины 18-24 лет;
  - Внедрить триггеры возврата- уведомления, персональные рекомендации.

 ### Вывод  
 Компания успешна по привлечению, но требует срочных мер по удержанию аудитории.


  ## Событие № 2: Резкое падение аудитории 24.08.25
  
 ![DAU](https://github.com/Alexa-grab/desktop-tutorial/blob/main/%D0%BF%D0%B0%D0%B4%D0%B5%D0%BD%D0%B8%D0%B5%205.png)

 - ### DAU за период с 19.08.25 по 26.08.25
 
   **Выводы по графикам**
  
   - Зафиксировано резкое снижение DAU 24.08.25 - минус 2 122 пользователя по сравнению с предыдущим днем;
   - Падение составило около 2,7% от общей аудитории;
   - Снижение нетипично резкое - не соответствует обычным колебаниям активности.

 - ### Основные события за сутки

![Основыне события](https://github.com/Alexa-grab/desktop-tutorial/blob/main/%D0%BF%D0%B0%D0%B4%D0%B5%D0%BD%D0%B8%D0%B5%206.png)

  - СTR с интервалом 30 мин;
  - Все события с интервалом 30 мин;
  - Лайки и просмотры с интервалом 30 мин.

   **Выводы по графикам**  

   - Сбой произошел в ночь с 23.08 на 24.08 - система уже к началу суток 24.08 работала нестабильно.
   - Технический инцидент начался за несколько часов до первых видимых симптомов в 6:00. Необходимо анализировать логи с полуночи 24.08.
       
     **Хронология:**
      - Ночь 23.08-24.08 - начало технических проблем;
      - 6:00 утра - уже явное падение CTR;
      - Весь день 24.08 - стабильно низкие показатели вовлеченности;
      - 21:00 - попытка фикса/перезапуска системы.
  
 - ### География активностей
  
  ![города](https://github.com/Alexa-grab/desktop-tutorial/blob/main/%D0%BF%D0%B0%D0%B4%D0%B5%D0%BD%D0%B8%D0%B5%207%20%D0%B3%D0%BE%D1%80%D0%BE%D0%B4%D0%B0.png)

   **Выводы по графикам**  
     
  **24.08** произошел региональный сбой - отсутствуют пользователи из ключевых городов:
   - Москва (обычно №1 по активности)
   - Санкт-Петербург (обычно №2)
   - Новосибирск, Екатеринбург (топ-5)

 - ### Активность по источнику входа и операционной системе в период с 19.08 по 26.08

![ос и источник входа](https://github.com/Alexa-grab/desktop-tutorial/blob/main/%D0%BF%D0%B0%D0%B4%D0%B5%D0%BD%D0%B8%D0%B5%209%20.png)

   **Выводы по графикам**  

   **1. Активность по источнику входа:**
   - Органический трафик упал значительно сильнее рекламного;
   - Оба источника показывают резкое снижение 24.08.

   **2. Активность по ОС:**
   - Android: катастрофическое падение на 502K событий (-65%);
   - iOS: значительное снижение на 273K событий (-59%).

 ## Падение аудитории: Основные выводы и рекомендации  
  
  **Падение аудитории 24.08.25 — результат технического сбоя инфраструктуры.**

 **1. Что произошло:**
  - **Региональный сбой:** пользователи из Москвы, СПб, Новосибирска и других крупных городов не могли получить доступ к приложению.
  - **Хронология:** проблемы начались ночью 23.08-24.08, пик падения пришелся на день 24.08, стабилизация к 21:00.
  - **Масштаб:** потеря ~ 2 122 пользователей (-2,7% от общей базы).
    
  **2. Сильнее всего затронуты:**
   - Органический трафик (наибольшее падение активности),
   - Пользователи Android (снижение на 502 тыс. событий, −65%).
   - Крупные города (Москва, СПб, Новосибирск).

 **3. Возможные причины:**
   - **Сбои в ключевых регионах инфраструктуры:**
     - DNS;
     - CDN;
     - Магистральные каналы связи.
    
 **4. Рекомендации:**
   - Провести детальный разбор инцидента с командой инфраструктуры: проверить логи DNS, CDN и сетевых провайдеров за 24.08.
   - Настроить мониторинг доступности по регионам, ОС и типам трафика (органический/рекламный).
   - Приоритетно усилить стабильность платформы для Android - как основной платформы органической аудитории.
   - Создать план быстрого реагирования на региональные сбои (переключение на резервные серверы, смена CDN).
   - Проработать коммуникацию для пользователей из пострадавших регионов (push-уведомления, соцсети) при повторении инцидента.

  ### Вывод  
  Проблема не в продукте, а в инфраструктуре — требуется усилить её отказоустойчивость, особенно для Android-устройств и органического трафика, составляющих основу аудитории.

  
  
 
